package com.issuetracker.service;

import com.issuetracker.dto.CreateIssueRequest;
import com.issuetracker.dto.IssueDto;
import com.issuetracker.dto.StatusUpdateRequest;
import com.issuetracker.entity.*;
import com.issuetracker.repository.*;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.transaction.annotation.Transactional;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * Test to verify that issues can be reopened from DONE to any other status.
 * NEW RULE: Any issue can transition from any status to any other status directly.
 */
@SpringBootTest
@ActiveProfiles("test")
@Transactional
public class IssueWorkflowReopenTest {

    @Autowired
    private IssueService issueService;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ProjectRepository projectRepository;

    @Autowired
    private IssueTypeRepository issueTypeRepository;

    private User testUser;
    private Project testProject;
    private IssueType storyType;
    private IssueType epicType;

    @BeforeEach
    void setUp() {
        // Create test user
        testUser = new User("test@example.com", "password", "Test User");
        testUser = userRepository.save(testUser);

        // Create test project
        testProject = new Project(testUser, "Test Project", "TP", "Test project description");
        testProject = projectRepository.save(testProject);

        // Create issue types (global types)
        storyType = new IssueType("STORY", "Story issue type", true);
        storyType = issueTypeRepository.save(storyType);
        
        epicType = new IssueType("EPIC", "Epic issue type", true);
        epicType = issueTypeRepository.save(epicType);
    }

    @Test
    void testIssueCanBeReopenedFromDoneToBacklog() {
        // Create an epic
        CreateIssueRequest epicRequest = new CreateIssueRequest(
                "Test Epic",
                "Epic for testing reopen",
                Priority.HIGH,
                testProject.getId(),
                epicType.getId()
        );
        IssueDto epic = issueService.createIssue(epicRequest, testUser);

        // Create a child issue
        CreateIssueRequest childRequest = new CreateIssueRequest(
                "Child Story",
                "Child story for testing reopen",
                Priority.HIGH,
                testProject.getId(),
                storyType.getId()
        );
        childRequest.setParentIssueId(epic.getId());
        IssueDto child = issueService.createIssue(childRequest, testUser);

        // Complete the child issue (NEW RULE: can go directly to DONE)
        issueService.updateIssueStatus(child.getId(), 
                new StatusUpdateRequest(IssueStatus.DONE), testUser);

        // Verify child is DONE
        IssueDto completedChild = issueService.getIssue(child.getId(), testUser);
        assertThat(completedChild.getStatus()).isEqualTo(IssueStatus.DONE);

        // Verify epic is auto-completed
        IssueDto completedEpic = issueService.getIssue(epic.getId(), testUser);
        assertThat(completedEpic.getStatus()).isEqualTo(IssueStatus.DONE);

        // Now reopen the child issue to BACKLOG (NEW RULE: direct transition allowed)
        issueService.updateIssueStatus(child.getId(), 
                new StatusUpdateRequest(IssueStatus.BACKLOG), testUser);

        // Verify child is back to BACKLOG
        IssueDto reopenedChild = issueService.getIssue(child.getId(), testUser);
        assertThat(reopenedChild.getStatus()).isEqualTo(IssueStatus.BACKLOG);

        // Verify epic is reverted to IN_PROGRESS
        IssueDto revertedEpic = issueService.getIssue(epic.getId(), testUser);
        assertThat(revertedEpic.getStatus()).isEqualTo(IssueStatus.IN_PROGRESS);
    }

    @Test
    void testIssueCanBeReopenedFromDoneToInReview() {
        // Create an epic
        CreateIssueRequest epicRequest = new CreateIssueRequest(
                "Test Epic",
                "Epic for testing reopen to review",
                Priority.HIGH,
                testProject.getId(),
                epicType.getId()
        );
        IssueDto epic = issueService.createIssue(epicRequest, testUser);

        // Create a child issue
        CreateIssueRequest childRequest = new CreateIssueRequest(
                "Child Story",
                "Child story for testing reopen to review",
                Priority.HIGH,
                testProject.getId(),
                storyType.getId()
        );
        childRequest.setParentIssueId(epic.getId());
        IssueDto child = issueService.createIssue(childRequest, testUser);

        // Complete the child issue (NEW RULE: can go directly to DONE)
        issueService.updateIssueStatus(child.getId(), 
                new StatusUpdateRequest(IssueStatus.DONE), testUser);

        // Verify child is DONE and epic is auto-completed
        IssueDto completedChild = issueService.getIssue(child.getId(), testUser);
        assertThat(completedChild.getStatus()).isEqualTo(IssueStatus.DONE);

        IssueDto completedEpic = issueService.getIssue(epic.getId(), testUser);
        assertThat(completedEpic.getStatus()).isEqualTo(IssueStatus.DONE);

        // Now reopen the child issue to IN_REVIEW (NEW RULE: direct transition allowed)
        issueService.updateIssueStatus(child.getId(), 
                new StatusUpdateRequest(IssueStatus.IN_REVIEW), testUser);

        // Verify child is back to IN_REVIEW
        IssueDto reopenedChild = issueService.getIssue(child.getId(), testUser);
        assertThat(reopenedChild.getStatus()).isEqualTo(IssueStatus.IN_REVIEW);

        // Verify epic is reverted to IN_PROGRESS
        IssueDto revertedEpic = issueService.getIssue(epic.getId(), testUser);
        assertThat(revertedEpic.getStatus()).isEqualTo(IssueStatus.IN_PROGRESS);
    }

    @Test
    void testDirectTransitionFromBacklogToDone() {
        // Create an epic
        CreateIssueRequest epicRequest = new CreateIssueRequest(
                "Test Epic",
                "Epic for testing direct transition",
                Priority.HIGH,
                testProject.getId(),
                epicType.getId()
        );
        IssueDto epic = issueService.createIssue(epicRequest, testUser);

        // Create a child issue
        CreateIssueRequest childRequest = new CreateIssueRequest(
                "Child Story",
                "Child story for testing direct transition",
                Priority.HIGH,
                testProject.getId(),
                storyType.getId()
        );
        childRequest.setParentIssueId(epic.getId());
        IssueDto child = issueService.createIssue(childRequest, testUser);

        // Verify child starts in BACKLOG
        assertThat(child.getStatus()).isEqualTo(IssueStatus.BACKLOG);

        // NEW RULE: Go directly from BACKLOG to DONE
        issueService.updateIssueStatus(child.getId(), 
                new StatusUpdateRequest(IssueStatus.DONE), testUser);

        // Verify child is now DONE
        IssueDto completedChild = issueService.getIssue(child.getId(), testUser);
        assertThat(completedChild.getStatus()).isEqualTo(IssueStatus.DONE);

        // Verify epic is auto-completed
        IssueDto completedEpic = issueService.getIssue(epic.getId(), testUser);
        assertThat(completedEpic.getStatus()).isEqualTo(IssueStatus.DONE);
    }
}